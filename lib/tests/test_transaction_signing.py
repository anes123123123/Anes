import unittest
import copy

from lib.transaction import (Transaction, deserialize)
import lib.bitcoin as bitcoin


class TestTransaction(unittest.TestCase):

    def test_tx_p2pkh_compressed(self):
        # deterministic standard wallet
        # 2 in, 2 out, all p2pkh with compressed pubkeys

        tx_unsigned_deserialized = {'lockTime':1227488,'inputs':[{'scriptSig':'01ff4c53ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000500','x_pubkeys':['ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000500'],'type':'p2pkh','prevout_hash':'53071755d9352ca3781627f5845327bcb8c7f482c4e8d8977ffcab75c3dcc24b','sequence':4294967294,'num_sig':1,'pubkeys':['02cff02a19fcb53628930d571a948fd7268fa90f24693f8941063e239d4b0fd93f'],'prevout_n':2,'signatures':[None],'address':'n4FcEmhBBrdKeXPUDpd1Mrmi4hTv1GxbhC'},{'scriptSig':'01ff4c53ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000600','x_pubkeys':['ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000600'],'type':'p2pkh','prevout_hash':'67c02bf25c4a580b6fa70675de32abdc1318b1daf1954617f884c08c12b22244','sequence':4294967294,'num_sig':1,'pubkeys':['03c427181d7f2f146a826ab7f7cff0675685fe366cbd112a78c051f2958907a369'],'prevout_n':0,'signatures':[None],'address':'n3iWvKjqMLerHWwjvb2K6MipUvdJwjVvqZ'}],'outputs':[{'scriptPubKey':'76a914e510b5e9dcc8d669c7b46484f36a3a668253c08488ac','address':'n2Q944CfqnWRkEmBkiX3qZsGzp6rTqmqcJ','prevout_n':0,'value':9998500,'type':0},{'scriptPubKey':'76a91404f451d6640b6d6e2bafe9fbacf669624850257788ac','address':'mfy9gT4YHyvB5MCxchAg1GWEvp2PbSaAUC','prevout_n':1,'value':120000000,'type':0}],'version':1}
        tx_unsigned_raw = '01000000024bc2dcc375abfc7f97d8e8c482f4c7b8bc275384f5271678a32c35d955170753020000005701ff4c53ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000500feffffff4422b2128cc084f8174695f1dab11813dcab32de7506a76f0b584a5cf22bc067000000005701ff4c53ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000600feffffff02a4909800000000001976a914e510b5e9dcc8d669c7b46484f36a3a668253c08488ac000e2707000000001976a91404f451d6640b6d6e2bafe9fbacf669624850257788ace0ba1200'

        tx_signed_deserialized = {'outputs':[{'value':9998500,'type':0,'prevout_n':0,'scriptPubKey':'76a914e510b5e9dcc8d669c7b46484f36a3a668253c08488ac','address':'n2Q944CfqnWRkEmBkiX3qZsGzp6rTqmqcJ'},{'value':120000000,'type':0,'prevout_n':1,'scriptPubKey':'76a91404f451d6640b6d6e2bafe9fbacf669624850257788ac','address':'mfy9gT4YHyvB5MCxchAg1GWEvp2PbSaAUC'}],'lockTime':1227488,'inputs':[{'type':'p2pkh','pubkeys':['02cff02a19fcb53628930d571a948fd7268fa90f24693f8941063e239d4b0fd93f'],'signatures':['3045022100ee2f72e2db0fc601b1d62ed15f971ab651a7d9947185466607964828a1bf24d9022079c45c959f36fa23db26680d417e5ec5e29001c9e3607c6d874050766c903b0c01'],'sequence':4294967294,'num_sig':1,'prevout_hash':'53071755d9352ca3781627f5845327bcb8c7f482c4e8d8977ffcab75c3dcc24b','scriptSig':'483045022100ee2f72e2db0fc601b1d62ed15f971ab651a7d9947185466607964828a1bf24d9022079c45c959f36fa23db26680d417e5ec5e29001c9e3607c6d874050766c903b0c012102cff02a19fcb53628930d571a948fd7268fa90f24693f8941063e239d4b0fd93f','x_pubkeys':['02cff02a19fcb53628930d571a948fd7268fa90f24693f8941063e239d4b0fd93f'],'prevout_n':2,'address':'n4FcEmhBBrdKeXPUDpd1Mrmi4hTv1GxbhC'},{'type':'p2pkh','pubkeys':['03c427181d7f2f146a826ab7f7cff0675685fe366cbd112a78c051f2958907a369'],'signatures':['3045022100ded0a8e4ec1dc5ca33ba1f55f1024a66bd59e206b83e7243575a375d2576e92a022062b3987dd6b91d10240b098aea4b8e5168350667df8b19d8f6ff5eee5db36c4401'],'sequence':4294967294,'num_sig':1,'prevout_hash':'67c02bf25c4a580b6fa70675de32abdc1318b1daf1954617f884c08c12b22244','scriptSig':'483045022100ded0a8e4ec1dc5ca33ba1f55f1024a66bd59e206b83e7243575a375d2576e92a022062b3987dd6b91d10240b098aea4b8e5168350667df8b19d8f6ff5eee5db36c44012103c427181d7f2f146a826ab7f7cff0675685fe366cbd112a78c051f2958907a369','x_pubkeys':['03c427181d7f2f146a826ab7f7cff0675685fe366cbd112a78c051f2958907a369'],'prevout_n':0,'address':'n3iWvKjqMLerHWwjvb2K6MipUvdJwjVvqZ'}],'version':1}
        tx_signed_raw = '01000000024bc2dcc375abfc7f97d8e8c482f4c7b8bc275384f5271678a32c35d955170753020000006b483045022100ee2f72e2db0fc601b1d62ed15f971ab651a7d9947185466607964828a1bf24d9022079c45c959f36fa23db26680d417e5ec5e29001c9e3607c6d874050766c903b0c012102cff02a19fcb53628930d571a948fd7268fa90f24693f8941063e239d4b0fd93ffeffffff4422b2128cc084f8174695f1dab11813dcab32de7506a76f0b584a5cf22bc067000000006b483045022100ded0a8e4ec1dc5ca33ba1f55f1024a66bd59e206b83e7243575a375d2576e92a022062b3987dd6b91d10240b098aea4b8e5168350667df8b19d8f6ff5eee5db36c44012103c427181d7f2f146a826ab7f7cff0675685fe366cbd112a78c051f2958907a369feffffff02a4909800000000001976a914e510b5e9dcc8d669c7b46484f36a3a668253c08488ac000e2707000000001976a91404f451d6640b6d6e2bafe9fbacf669624850257788ace0ba1200'

        keypairs = {
          'ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000600':
              (b'\xf6\xe5\xa2\x9b(\xc5\x06\xca\x8d\x07\xd1{/+_N\xd9I,\x1c: UZ*Q\x18nl\xbel\xaf', True),
          'ff0488b21e000000000000000000793da0e31a825b999e78c44b5ceb24788cd78d70cb0a36caa84ef0bf0ac52f98034ed85be91b380f371b42409688d23b0dd0343f31fb2754a14dbf816f5996531c00000500':
              (b"\xb7M\x00\xe5U\xe6X\xcfCp'~\x96\xb8P\xaa\xfc\x13\xe8F\x81^J\x05\x19 \xc0\x9b\xc8V`\xb2", True)
        }
        txid = '0f1a96d56fd1f4f0a157726ad52ffc0d482e4e0e470f5d6a10936e60f39a8900'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed_deserialized),
            (tx_unsigned_raw, tx_signed_raw),
            (keypairs,),
            txid
        )

    def test_tx_p2pkh_uncompressed(self):
        # deterministic old wallet
        # 2 in, 2 out, all p2pkh with uncompressed pubkeys

        tx_unsigned_deserialized = {'lockTime':1230164,'outputs':[{'value':19994800,'scriptPubKey':'76a914ca14915184a2662b5d1505ce7142c8ca066c70e288ac','prevout_n':0,'type':0,'address':'mywTRsN56GipUEbmCnoUV9YFdrUU5CmUxd'},{'value':40000000,'scriptPubKey':'76a9145eb4eeaefcf9a709f8671444933243fbd05366a388ac','prevout_n':1,'type':0,'address':'mp9iZVBSUokAUX1p57Kjc4mHrtqqEhxjrh'}],'version':1,'inputs':[{'scriptSig':'01ff45fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000000','x_pubkeys':['fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000000'],'prevout_n':0,'sequence':4294967294,'prevout_hash':'a29d131e766950cae2e97dd4527b7c050293c2f5630470bdd7d00b7fe6db1b9d','address':'mupBXEDhWQnrmyW4TukDs2qcqQrhRJGrQd','type':'p2pkh','pubkeys':['045f7ba332df2a7b4f5d13f246e307c9174cfa9b8b05f3b83410a3c23ef8958d610be285963d67c7bc1feb082f168fa9877c25999963ff8b56b242a852b23e25ed'],'num_sig':1,'signatures':[None]},{'scriptSig':'01ff45fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000100','x_pubkeys':['fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000100'],'prevout_n':1,'sequence':4294967294,'prevout_hash':'a29d131e766950cae2e97dd4527b7c050293c2f5630470bdd7d00b7fe6db1b9d','address':'myJLELfyhG1Fu7iPyfpHfviVCQuLwsNCBm','type':'p2pkh','pubkeys':['04dc28da82e141416aaf771eb78128d00a55fdcbd13622afcbb7a3b911e58baa6a99841bfb7b99bcb7e1d47904fda5d13fdf9675cdbbe73e44efcc08165f49bac6'],'num_sig':1,'signatures':[None]}]}
        tx_unsigned_raw = '01000000029d1bdbe67f0bd0d7bd700463f5c29302057c7b52d47de9e2ca5069761e139da2000000004801ff45fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000000feffffff9d1bdbe67f0bd0d7bd700463f5c29302057c7b52d47de9e2ca5069761e139da2010000004801ff45fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000100feffffff02b0183101000000001976a914ca14915184a2662b5d1505ce7142c8ca066c70e288ac005a6202000000001976a9145eb4eeaefcf9a709f8671444933243fbd05366a388ac54c51200'

        tx_signed_deserialized = {'lockTime':1230164,'outputs':[{'value':19994800,'scriptPubKey':'76a914ca14915184a2662b5d1505ce7142c8ca066c70e288ac','prevout_n':0,'type':0,'address':'mywTRsN56GipUEbmCnoUV9YFdrUU5CmUxd'},{'value':40000000,'scriptPubKey':'76a9145eb4eeaefcf9a709f8671444933243fbd05366a388ac','prevout_n':1,'type':0,'address':'mp9iZVBSUokAUX1p57Kjc4mHrtqqEhxjrh'}],'version':1,'inputs':[{'scriptSig':'483045022100a146a2078a318c1266e42265a369a8eef8993750cb3faa8dd80754d8d541d5d202207a6ab8864986919fd1a7fd5854f1e18a8a0431df924d7a878ec3dc283e3d75340141045f7ba332df2a7b4f5d13f246e307c9174cfa9b8b05f3b83410a3c23ef8958d610be285963d67c7bc1feb082f168fa9877c25999963ff8b56b242a852b23e25ed','x_pubkeys':['045f7ba332df2a7b4f5d13f246e307c9174cfa9b8b05f3b83410a3c23ef8958d610be285963d67c7bc1feb082f168fa9877c25999963ff8b56b242a852b23e25ed'],'prevout_n':0,'sequence':4294967294,'prevout_hash':'a29d131e766950cae2e97dd4527b7c050293c2f5630470bdd7d00b7fe6db1b9d','address':'mupBXEDhWQnrmyW4TukDs2qcqQrhRJGrQd','type':'p2pkh','pubkeys':['045f7ba332df2a7b4f5d13f246e307c9174cfa9b8b05f3b83410a3c23ef8958d610be285963d67c7bc1feb082f168fa9877c25999963ff8b56b242a852b23e25ed'],'num_sig':1,'signatures':['3045022100a146a2078a318c1266e42265a369a8eef8993750cb3faa8dd80754d8d541d5d202207a6ab8864986919fd1a7fd5854f1e18a8a0431df924d7a878ec3dc283e3d753401']},{'scriptSig':'47304402201c7fa37b74a915668b0244c01f14a9756bbbec1031fb69390bcba236148ab37e02206151581f9aa0e6758b503064c1e661a726d75c6be3364a5a121a8c12cf618f64014104dc28da82e141416aaf771eb78128d00a55fdcbd13622afcbb7a3b911e58baa6a99841bfb7b99bcb7e1d47904fda5d13fdf9675cdbbe73e44efcc08165f49bac6','x_pubkeys':['04dc28da82e141416aaf771eb78128d00a55fdcbd13622afcbb7a3b911e58baa6a99841bfb7b99bcb7e1d47904fda5d13fdf9675cdbbe73e44efcc08165f49bac6'],'prevout_n':1,'sequence':4294967294,'prevout_hash':'a29d131e766950cae2e97dd4527b7c050293c2f5630470bdd7d00b7fe6db1b9d','address':'myJLELfyhG1Fu7iPyfpHfviVCQuLwsNCBm','type':'p2pkh','pubkeys':['04dc28da82e141416aaf771eb78128d00a55fdcbd13622afcbb7a3b911e58baa6a99841bfb7b99bcb7e1d47904fda5d13fdf9675cdbbe73e44efcc08165f49bac6'],'num_sig':1,'signatures':['304402201c7fa37b74a915668b0244c01f14a9756bbbec1031fb69390bcba236148ab37e02206151581f9aa0e6758b503064c1e661a726d75c6be3364a5a121a8c12cf618f6401']}]}
        tx_signed_raw = '01000000029d1bdbe67f0bd0d7bd700463f5c29302057c7b52d47de9e2ca5069761e139da2000000008b483045022100a146a2078a318c1266e42265a369a8eef8993750cb3faa8dd80754d8d541d5d202207a6ab8864986919fd1a7fd5854f1e18a8a0431df924d7a878ec3dc283e3d75340141045f7ba332df2a7b4f5d13f246e307c9174cfa9b8b05f3b83410a3c23ef8958d610be285963d67c7bc1feb082f168fa9877c25999963ff8b56b242a852b23e25edfeffffff9d1bdbe67f0bd0d7bd700463f5c29302057c7b52d47de9e2ca5069761e139da2010000008a47304402201c7fa37b74a915668b0244c01f14a9756bbbec1031fb69390bcba236148ab37e02206151581f9aa0e6758b503064c1e661a726d75c6be3364a5a121a8c12cf618f64014104dc28da82e141416aaf771eb78128d00a55fdcbd13622afcbb7a3b911e58baa6a99841bfb7b99bcb7e1d47904fda5d13fdf9675cdbbe73e44efcc08165f49bac6feffffff02b0183101000000001976a914ca14915184a2662b5d1505ce7142c8ca066c70e288ac005a6202000000001976a9145eb4eeaefcf9a709f8671444933243fbd05366a388ac54c51200'

        keypairs = {
          'fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000000':
              (b'\x8f\xdf[\xc0\xfd\xd0\xbc\xfb\x03\xdd-\x05\r\x90:x>[6\xde\x98\xf3\x96:\x02].\x8f\x06)\xfa\xa5', False),
          'fee9d4b7866dd1e91c862aebf62a49548c7dbf7bcc6e4b7b8c9da820c7737968df9c09d5a3e271dc814a29981f81b3faaf2737b551ef5dcc6189cf0f8252c442b300000100':
              (b"\x81\xc6\xba<\xd6xOd(Y?C'\xc08\xe8\xe2\x12%W/*\x95\x10\x00E\x05h:iF%", False)
        }
        txid = '0f4972c84974b908a58dda2614b68cf037e6c03e8291898c719766f213217b67'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed_deserialized),
            (tx_unsigned_raw, tx_signed_raw),
            (keypairs,),
            txid
        )

    def test_tx_p2wpkh_p2sh(self):
        # bip39 seeded wallet with bip49 derivation
        # 2 in, 2 out, all p2wpkh-p2sh with compressed pubkeys

        tx_unsigned_deserialized = {'lockTime':1230194,'inputs':[{'prevout_n':0,'signatures':[None],'num_sig':1,'prevout_hash':'9bec55488761b683940a0699b29112667e6704b5763f254ebcec33c0782faee6','pubkeys':['03b5bda901bc411d2932fbd3df0ba74fff915b8a69ffc4c8e22b8f10eb7004b256'],'type':'p2wpkh-p2sh','sequence':4294967293,'address':'2MyVSu8huh58kzCPnbvvxuTECsUCkjAQtcY','value':149999600,'scriptSig':'160014f532654adfa2dcf555d16e73a7370c8c9b1c5e6b','x_pubkeys':['ff049d7cb2033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c300000000']},{'prevout_n':0,'signatures':[None],'num_sig':1,'prevout_hash':'a970b0dc775d0ee86071be64d1bf36b1200afd540696a0ea64f45af249be7e41','pubkeys':['022e1b7a1f4a00492abec38ad7e0e73ce4c42cf1716b851e02954c58c35a94542a'],'type':'p2wpkh-p2sh','sequence':4294967293,'address':'2NCVwbmEpvaXKHpXUGJfJr9iB5vtRN3vcut','value':32490700,'scriptSig':'160014bb69bdc1c1dcb28cabc1c2243f68cecfd2d84a37','x_pubkeys':['ff049d7cb2033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c300000100']}],'outputs':[{'type':0,'scriptPubKey':'a914b4b4dfe72b0bd34d52f8178f39909c88919f1fb587','address':'2N9iiJChCm95XnwR3JTo51vJNHMgpeUkT6C','value':32489900,'prevout_n':0},{'type':0,'scriptPubKey':'a914f6ee606702078d2ff5cf826c9fd5581a7f7c8b0b87','address':'2NFksnAk7kfpLsKFgUa3ML4riSGwJ73R2Y2','value':150000000,'prevout_n':1}],'version':1}
        tx_unsigned_raw = '01000000000102e6ae2f78c033ecbc4e253f76b504677e661291b299060a9483b661874855ec9b0000000017160014f532654adfa2dcf555d16e73a7370c8c9b1c5e6bfdffffff417ebe49f25af464eaa0960654fd0a20b136bfd164be7160e80e5d77dcb070a90000000017160014bb69bdc1c1dcb28cabc1c2243f68cecfd2d84a37fdffffff02acc1ef010000000017a914b4b4dfe72b0bd34d52f8178f39909c88919f1fb58780d1f0080000000017a914f6ee606702078d2ff5cf826c9fd5581a7f7c8b0b87fefffffffff0cff008000000000201ff53ff049d7cb2033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c300000000feffffffffccc4ef01000000000201ff53ff049d7cb2033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c30000010072c51200'

        tx_signed_deserialized = {'lockTime':1230194,'inputs':[{'prevout_n':0,'signatures':['3044022016edbfb2c1ef1f796a41bcafb8715148d56c255f04ca0b72b237b01453f638b5022018284d501779fbef277b99f0bebe32bdfa325fc6422fa90fbc8cf7781caff31101'],'num_sig':1,'prevout_hash':'9bec55488761b683940a0699b29112667e6704b5763f254ebcec33c0782faee6','pubkeys':['03b5bda901bc411d2932fbd3df0ba74fff915b8a69ffc4c8e22b8f10eb7004b256'],'type':'p2wpkh-p2sh','sequence':4294967293,'address':'2MyVSu8huh58kzCPnbvvxuTECsUCkjAQtcY','scriptSig':'160014f532654adfa2dcf555d16e73a7370c8c9b1c5e6b','x_pubkeys':['03b5bda901bc411d2932fbd3df0ba74fff915b8a69ffc4c8e22b8f10eb7004b256']},{'prevout_n':0,'signatures':['304402203bd8ee004509b71dc7ff10487a6e2e1315b858c3b3758bf091539bcdca1667a702204f36ca1e6cc4ac449836b104503ce13fd07a4153757506601b8ca3cb2a4c57dd01'],'num_sig':1,'prevout_hash':'a970b0dc775d0ee86071be64d1bf36b1200afd540696a0ea64f45af249be7e41','pubkeys':['022e1b7a1f4a00492abec38ad7e0e73ce4c42cf1716b851e02954c58c35a94542a'],'type':'p2wpkh-p2sh','sequence':4294967293,'address':'2NCVwbmEpvaXKHpXUGJfJr9iB5vtRN3vcut','scriptSig':'160014bb69bdc1c1dcb28cabc1c2243f68cecfd2d84a37','x_pubkeys':['022e1b7a1f4a00492abec38ad7e0e73ce4c42cf1716b851e02954c58c35a94542a']}],'outputs':[{'type':0,'scriptPubKey':'a914b4b4dfe72b0bd34d52f8178f39909c88919f1fb587','address':'2N9iiJChCm95XnwR3JTo51vJNHMgpeUkT6C','value':32489900,'prevout_n':0},{'type':0,'scriptPubKey':'a914f6ee606702078d2ff5cf826c9fd5581a7f7c8b0b87','address':'2NFksnAk7kfpLsKFgUa3ML4riSGwJ73R2Y2','value':150000000,'prevout_n':1}],'version':1}
        tx_signed_raw = '01000000000102e6ae2f78c033ecbc4e253f76b504677e661291b299060a9483b661874855ec9b0000000017160014f532654adfa2dcf555d16e73a7370c8c9b1c5e6bfdffffff417ebe49f25af464eaa0960654fd0a20b136bfd164be7160e80e5d77dcb070a90000000017160014bb69bdc1c1dcb28cabc1c2243f68cecfd2d84a37fdffffff02acc1ef010000000017a914b4b4dfe72b0bd34d52f8178f39909c88919f1fb58780d1f0080000000017a914f6ee606702078d2ff5cf826c9fd5581a7f7c8b0b8702473044022016edbfb2c1ef1f796a41bcafb8715148d56c255f04ca0b72b237b01453f638b5022018284d501779fbef277b99f0bebe32bdfa325fc6422fa90fbc8cf7781caff311012103b5bda901bc411d2932fbd3df0ba74fff915b8a69ffc4c8e22b8f10eb7004b2560247304402203bd8ee004509b71dc7ff10487a6e2e1315b858c3b3758bf091539bcdca1667a702204f36ca1e6cc4ac449836b104503ce13fd07a4153757506601b8ca3cb2a4c57dd0121022e1b7a1f4a00492abec38ad7e0e73ce4c42cf1716b851e02954c58c35a94542a72c51200'

        keypairs = {
          'ff049d7cb2033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c300000100':
              (b'~\xda\x82\xd4K\xd9B\xce\xd3\x9b\xdb\xb4\xbe\xcb\xaeo\x92\xf0y\xf3\x8de\x0f\xab\xb5\xd6\x89\xe9k\xcc<K', True),
          'ff049d7cb2033601222e800000001618aa51e49a961f63fd111f64cd4a7e792c1d7168be7a07703de505ebed2cf70286ebbe755767adaa5835f4d78dec1ee30849d69eacfe80b7ee6b1585279536c300000000':
              (b'/\xb7c*\x0b}q\xbaTjH\xb3\xc1\x84`\x97g\x01\xb5\x06\xc5)-\xfdoD\xacZ\xbc\xcc\xa2\xe8', True)
        }
        txid = 'b1bacde1bef460afc9c94091e79192e6044590454b92493676d0b315a294d09d'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed_deserialized),
            (tx_unsigned_raw, tx_signed_raw),
            (keypairs,),
            txid
        )

    def test_tx_p2wpkh(self):
        # deterministic segwit wallet
        # 2 in, 2 out, all p2wpkh with compressed pubkeys

        tx_unsigned_deserialized = {'inputs':[{'address':'tb1qju64xjlnarxxwr5y8l0zm0jt2gyevtv7llck09','sequence':4294967293,'signatures':[None],'num_sig':1,'value':82498650,'prevout_n':0,'x_pubkeys':['ff04b24746014af5fa07800000002fa3f450ba41799b9b62642979505817783a9b6c656dc11cd0bb4fa362096808026adc616c25a4d0a877d1741eb1db9cef65c15118bd7d5f31bf65f319edda818400000500'],'pubkeys':['03d13b335aeae4434c0b50a5b3d5ae53e5ec349258cdb356a39343ba4dc286ce0c'],'scriptSig':'','prevout_hash':'5f29e47be8c5200b8678fb007c5f3641f4871b1acc391ff93f8c35ea6f40ad70','type':'p2wpkh'},{'address':'tb1qp5ncp3xf2783fhye82lwdtk58jadnkqqmz77ey','sequence':4294967293,'signatures':[None],'num_sig':1,'value':9999620,'prevout_n':0,'x_pubkeys':['ff04b24746014af5fa07800000002fa3f450ba41799b9b62642979505817783a9b6c656dc11cd0bb4fa362096808026adc616c25a4d0a877d1741eb1db9cef65c15118bd7d5f31bf65f319edda818400000600'],'pubkeys':['0211cc4cf1b2cb942ef0102f18207aa50d01bf4d567db8e96fce4d0fff05928d44'],'scriptSig':'','prevout_hash':'eaf9876d5e4984d44f2c34671ffff0fc83ee99ca01cb9adb94f89479a2de8102','type':'p2wpkh'}],'lockTime':1230167,'version':1,'outputs':[{'address':'tb1qewfl4r4lh398v203re376223rrvn7wyaewwnw5','scriptPubKey':'0014cb93fa8ebfbc4a7629f11e63ed295118d93f389d','value':7498000,'prevout_n':0,'type':0},{'address':'tb1qd4m98yerchgplsjw90a0zpt6s3uahyr3my57xk','scriptPubKey':'00146d76539323c5d01fc24e2bfaf1057a8479db9071','value':85000000,'prevout_n':1,'type':0}]}
        tx_unsigned_raw = '0100000000010270ad406fea358c3ff91f39cc1a1b87f441365f7c00fb78860b20c5e87be4295f0000000000fdffffff0281dea27994f894db9acb01ca99ee83fcf0ff1f67342c4fd484495e6d87f9ea0000000000fdffffff021069720000000000160014cb93fa8ebfbc4a7629f11e63ed295118d93f389d40ff1005000000001600146d76539323c5d01fc24e2bfaf1057a8479db9071feffffffff5ad4ea04000000000201ff53ff04b24746014af5fa07800000002fa3f450ba41799b9b62642979505817783a9b6c656dc11cd0bb4fa362096808026adc616c25a4d0a877d1741eb1db9cef65c15118bd7d5f31bf65f319edda818400000500feffffffff04959800000000000201ff53ff04b24746014af5fa07800000002fa3f450ba41799b9b62642979505817783a9b6c656dc11cd0bb4fa362096808026adc616c25a4d0a877d1741eb1db9cef65c15118bd7d5f31bf65f319edda81840000060057c51200'

        tx_signed_deserialized = {'inputs':[{'address':'tb1qju64xjlnarxxwr5y8l0zm0jt2gyevtv7llck09','sequence':4294967293,'signatures':['3045022100c69dff2637a070d35f24d9d8292bd6f80f13d54afdc7b92ada02ffe00802ee4302204ec3ffe3b397823aebef56f20b4b244e3eb5f5c15fcd5bbbc3b78e41183eeabf01'],'num_sig':1,'prevout_n':0,'x_pubkeys':['03d13b335aeae4434c0b50a5b3d5ae53e5ec349258cdb356a39343ba4dc286ce0c'],'pubkeys':['03d13b335aeae4434c0b50a5b3d5ae53e5ec349258cdb356a39343ba4dc286ce0c'],'scriptSig':'','prevout_hash':'5f29e47be8c5200b8678fb007c5f3641f4871b1acc391ff93f8c35ea6f40ad70','type':'p2wpkh'},{'address':'tb1qp5ncp3xf2783fhye82lwdtk58jadnkqqmz77ey','sequence':4294967293,'signatures':['3045022100d1d33c337265d7af006164a08a07955808ec6061171b59fe3f414a3597ea2e7702207457c7d0c2c22f8fe56d1da63ff5e851fc6323c92e7ee751c22dadf8836676ef01'],'num_sig':1,'prevout_n':0,'x_pubkeys':['0211cc4cf1b2cb942ef0102f18207aa50d01bf4d567db8e96fce4d0fff05928d44'],'pubkeys':['0211cc4cf1b2cb942ef0102f18207aa50d01bf4d567db8e96fce4d0fff05928d44'],'scriptSig':'','prevout_hash':'eaf9876d5e4984d44f2c34671ffff0fc83ee99ca01cb9adb94f89479a2de8102','type':'p2wpkh'}],'lockTime':1230167,'version':1,'outputs':[{'address':'tb1qewfl4r4lh398v203re376223rrvn7wyaewwnw5','scriptPubKey':'0014cb93fa8ebfbc4a7629f11e63ed295118d93f389d','value':7498000,'prevout_n':0,'type':0},{'address':'tb1qd4m98yerchgplsjw90a0zpt6s3uahyr3my57xk','scriptPubKey':'00146d76539323c5d01fc24e2bfaf1057a8479db9071','value':85000000,'prevout_n':1,'type':0}]}
        tx_signed_raw = '0100000000010270ad406fea358c3ff91f39cc1a1b87f441365f7c00fb78860b20c5e87be4295f0000000000fdffffff0281dea27994f894db9acb01ca99ee83fcf0ff1f67342c4fd484495e6d87f9ea0000000000fdffffff021069720000000000160014cb93fa8ebfbc4a7629f11e63ed295118d93f389d40ff1005000000001600146d76539323c5d01fc24e2bfaf1057a8479db907102483045022100c69dff2637a070d35f24d9d8292bd6f80f13d54afdc7b92ada02ffe00802ee4302204ec3ffe3b397823aebef56f20b4b244e3eb5f5c15fcd5bbbc3b78e41183eeabf012103d13b335aeae4434c0b50a5b3d5ae53e5ec349258cdb356a39343ba4dc286ce0c02483045022100d1d33c337265d7af006164a08a07955808ec6061171b59fe3f414a3597ea2e7702207457c7d0c2c22f8fe56d1da63ff5e851fc6323c92e7ee751c22dadf8836676ef01210211cc4cf1b2cb942ef0102f18207aa50d01bf4d567db8e96fce4d0fff05928d4457c51200'

        keypairs = {
          'ff04b24746014af5fa07800000002fa3f450ba41799b9b62642979505817783a9b6c656dc11cd0bb4fa362096808026adc616c25a4d0a877d1741eb1db9cef65c15118bd7d5f31bf65f319edda818400000500':
              (b'\xcar\xbd0Vk5\xfd\x17\x94\x1cj\xe9\xb7\x12\x81g\x8fo\x9f\xe6W\xdc\xa9\xad\x1fV2\x85EE\xfb', True),
          'ff04b24746014af5fa07800000002fa3f450ba41799b9b62642979505817783a9b6c656dc11cd0bb4fa362096808026adc616c25a4d0a877d1741eb1db9cef65c15118bd7d5f31bf65f319edda818400000600':
              (b'\x16\r\x9fu4\xde\x83d\x06A:A#\xd6\x16\xb3_\xe1T\xd4\xc1\xber\xbb-\x83\x8b\x1e\x81\x15\x1eN', True)
        }
        txid = '73bb6a249b8b5329b1e6156c19d4e7ecd2c644a6e97500ec2af8cdf2da8361d8'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed_deserialized),
            (tx_unsigned_raw, tx_signed_raw),
            (keypairs,),
            txid
        )

    def test_tx_mixed_singlesigner(self):
        # imported wallet
        # 4 in: p2pkh uncompressed, p2pkh compressed, p2wpkh-p2sh, p2wpkh
        # 4 out: p2pkh uncompressed, p2pkh compressed, p2wpkh-p2sh, p2wpkh

        tx_unsigned_deserialized = {'version':1,'inputs':[{'pubkeys':['028e6808a8ac1e9ede621aaabfcad6f86662dbe0ace0236f078eb23c24bc88bd5e'],'address':'2N3DKyq4jmKrRkBw5CU2FbYAxqNoAJX1BPY','value':20000000,'scriptSig':'16001441aec99157d762708339d7faf7a63a8c479ed84c','sequence':4294967293,'x_pubkeys':['028e6808a8ac1e9ede621aaabfcad6f86662dbe0ace0236f078eb23c24bc88bd5e'],'prevout_n':0,'signatures':[None],'num_sig':1,'prevout_hash':'1eef4751a4b8df7acb57589849bfe601a47f9ae390e8cdba390b71189f1b9496','type':'p2wpkh-p2sh'},{'pubkeys':['028641e89822127336fc12ff99b1089eb1a124847639a0e98d17ff03a135ad578b'],'address':'tb1qkz92fkgtn7m3lyu9lapv53vsfym2c04prdl05h','value':39999226,'scriptSig':'','sequence':4294967293,'x_pubkeys':['028641e89822127336fc12ff99b1089eb1a124847639a0e98d17ff03a135ad578b'],'prevout_n':1,'signatures':[None],'num_sig':1,'prevout_hash':'1eef4751a4b8df7acb57589849bfe601a47f9ae390e8cdba390b71189f1b9496','type':'p2wpkh'},{'pubkeys':['0375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fd'],'address':'mggNYvEsCcAd3zbkEk3LsPXA8uULuAfU9s','scriptSig':'01ff210375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fd','sequence':4294967293,'x_pubkeys':['0375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fd'],'prevout_n':0,'signatures':[None],'num_sig':1,'prevout_hash':'7f19935daa7347bdcf45f0bfd726dd665c514ffd49dfb035369813a54c1e5d1a','type':'p2pkh'},{'pubkeys':['04de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7c'],'address':'mxTwRCnJgafjVaUVLsniWZPpXhz5dFzRyb','scriptSig':'01ff4104de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7c','sequence':4294967293,'x_pubkeys':['04de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7c'],'prevout_n':1,'signatures':[None],'num_sig':1,'prevout_hash':'7f19935daa7347bdcf45f0bfd726dd665c514ffd49dfb035369813a54c1e5d1a','type':'p2pkh'}],'outputs':[{'address':'mupBXEDhWQnrmyW4TukDs2qcqQrhRJGrQd','scriptPubKey':'76a9149cd3dfb0d87a861770ae4e268e74b45335cf00ab88ac','value':10000000,'prevout_n':0,'type':0},{'address':'2NFNG2gDSSMtyuLJQG7ZxaTUE6DLgeAu9ED','scriptPubKey':'a914f2a76207d7b54bd34282281205923841341d9e1f87','value':10000000,'prevout_n':1,'type':0},{'address':'mxNF4oqNq53TFE7rMypd5vVqkYZquHYReJ','scriptPubKey':'76a914b8d4651937cd7db5bcf5fc98e6d2d8cfa131e85088ac','value':20000000,'prevout_n':2,'type':0},{'address':'tb1qclgd7z0qx9e3wzhdqfrjgwr5c6rjwj8dw99r8f','scriptPubKey':'0014c7d0df09e03173170aed0247243874c6872748ed','value':179453300,'prevout_n':3,'type':0}],'lockTime':1230624}
        tx_unsigned_raw = '0100000000010496941b9f18710b39bacde890e39a7fa401e6bf49985857cb7adfb8a45147ef1e000000001716001441aec99157d762708339d7faf7a63a8c479ed84cfdffffff96941b9f18710b39bacde890e39a7fa401e6bf49985857cb7adfb8a45147ef1e0100000000fdffffff1a5d1e4ca513983635b0df49fd4f515c66dd26d7bff045cfbd4773aa5d93197f000000002401ff210375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fdfdffffff1a5d1e4ca513983635b0df49fd4f515c66dd26d7bff045cfbd4773aa5d93197f010000004401ff4104de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7cfdffffff0480969800000000001976a9149cd3dfb0d87a861770ae4e268e74b45335cf00ab88ac809698000000000017a914f2a76207d7b54bd34282281205923841341d9e1f87002d3101000000001976a914b8d4651937cd7db5bcf5fc98e6d2d8cfa131e85088ac743db20a00000000160014c7d0df09e03173170aed0247243874c6872748edfeffffffff002d3101000000000201ff21028e6808a8ac1e9ede621aaabfcad6f86662dbe0ace0236f078eb23c24bc88bd5efefffffffffa566202000000000201ff21028641e89822127336fc12ff99b1089eb1a124847639a0e98d17ff03a135ad578b000020c71200'

        tx_signed_deserialized = {'version':1,'inputs':[{'pubkeys':['028e6808a8ac1e9ede621aaabfcad6f86662dbe0ace0236f078eb23c24bc88bd5e'],'address':'2N3DKyq4jmKrRkBw5CU2FbYAxqNoAJX1BPY','scriptSig':'16001441aec99157d762708339d7faf7a63a8c479ed84c','sequence':4294967293,'x_pubkeys':['028e6808a8ac1e9ede621aaabfcad6f86662dbe0ace0236f078eb23c24bc88bd5e'],'prevout_n':0,'signatures':['3045022100b932cda0aeb029922e126568a48c05d79317747dcd77e61dce44e190e140822002202d13f84338bb272c531c4086277ac11e166c59612f4aefa6e20f78455bdc099701'],'num_sig':1,'prevout_hash':'1eef4751a4b8df7acb57589849bfe601a47f9ae390e8cdba390b71189f1b9496','type':'p2wpkh-p2sh'},{'pubkeys':['028641e89822127336fc12ff99b1089eb1a124847639a0e98d17ff03a135ad578b'],'address':'tb1qkz92fkgtn7m3lyu9lapv53vsfym2c04prdl05h','scriptSig':'','sequence':4294967293,'x_pubkeys':['028641e89822127336fc12ff99b1089eb1a124847639a0e98d17ff03a135ad578b'],'prevout_n':1,'signatures':['3045022100d74a253262e3898626c12361ba9bb5866f9303b42eec0a55ced0578829e2e61e022059c08e61d90cd63c84de61c796c9d1bc1e2f8217892a7c07b383af357ddd7a7301'],'num_sig':1,'prevout_hash':'1eef4751a4b8df7acb57589849bfe601a47f9ae390e8cdba390b71189f1b9496','type':'p2wpkh'},{'pubkeys':['0375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fd'],'address':'mggNYvEsCcAd3zbkEk3LsPXA8uULuAfU9s','scriptSig':'4730440220652145460092ef42452437b942cb3f563bf15ad90d572d0b31d9f28449b7a8dd022052aae24f58b8f76bd2c9cf165cc98623f22870ccdbef1661b6dbe01c0ef9010f01210375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fd','sequence':4294967293,'x_pubkeys':['0375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fd'],'prevout_n':0,'signatures':['30440220652145460092ef42452437b942cb3f563bf15ad90d572d0b31d9f28449b7a8dd022052aae24f58b8f76bd2c9cf165cc98623f22870ccdbef1661b6dbe01c0ef9010f01'],'num_sig':1,'prevout_hash':'7f19935daa7347bdcf45f0bfd726dd665c514ffd49dfb035369813a54c1e5d1a','type':'p2pkh'},{'pubkeys':['04de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7c'],'address':'mxTwRCnJgafjVaUVLsniWZPpXhz5dFzRyb','scriptSig':'47304402207517c52b241e6638a84b05385e0b3df806478c2e444f671ca34921f6232ee2e70220624af63d357b83e3abe7cdf03d680705df0049ec02f02918ee371170e3b4a73d014104de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7c','sequence':4294967293,'x_pubkeys':['04de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7c'],'prevout_n':1,'signatures':['304402207517c52b241e6638a84b05385e0b3df806478c2e444f671ca34921f6232ee2e70220624af63d357b83e3abe7cdf03d680705df0049ec02f02918ee371170e3b4a73d01'],'num_sig':1,'prevout_hash':'7f19935daa7347bdcf45f0bfd726dd665c514ffd49dfb035369813a54c1e5d1a','type':'p2pkh'}],'outputs':[{'address':'mupBXEDhWQnrmyW4TukDs2qcqQrhRJGrQd','scriptPubKey':'76a9149cd3dfb0d87a861770ae4e268e74b45335cf00ab88ac','value':10000000,'prevout_n':0,'type':0},{'address':'2NFNG2gDSSMtyuLJQG7ZxaTUE6DLgeAu9ED','scriptPubKey':'a914f2a76207d7b54bd34282281205923841341d9e1f87','value':10000000,'prevout_n':1,'type':0},{'address':'mxNF4oqNq53TFE7rMypd5vVqkYZquHYReJ','scriptPubKey':'76a914b8d4651937cd7db5bcf5fc98e6d2d8cfa131e85088ac','value':20000000,'prevout_n':2,'type':0},{'address':'tb1qclgd7z0qx9e3wzhdqfrjgwr5c6rjwj8dw99r8f','scriptPubKey':'0014c7d0df09e03173170aed0247243874c6872748ed','value':179453300,'prevout_n':3,'type':0}],'lockTime':1230624}
        tx_signed_raw = '0100000000010496941b9f18710b39bacde890e39a7fa401e6bf49985857cb7adfb8a45147ef1e000000001716001441aec99157d762708339d7faf7a63a8c479ed84cfdffffff96941b9f18710b39bacde890e39a7fa401e6bf49985857cb7adfb8a45147ef1e0100000000fdffffff1a5d1e4ca513983635b0df49fd4f515c66dd26d7bff045cfbd4773aa5d93197f000000006a4730440220652145460092ef42452437b942cb3f563bf15ad90d572d0b31d9f28449b7a8dd022052aae24f58b8f76bd2c9cf165cc98623f22870ccdbef1661b6dbe01c0ef9010f01210375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fdfdffffff1a5d1e4ca513983635b0df49fd4f515c66dd26d7bff045cfbd4773aa5d93197f010000008a47304402207517c52b241e6638a84b05385e0b3df806478c2e444f671ca34921f6232ee2e70220624af63d357b83e3abe7cdf03d680705df0049ec02f02918ee371170e3b4a73d014104de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7cfdffffff0480969800000000001976a9149cd3dfb0d87a861770ae4e268e74b45335cf00ab88ac809698000000000017a914f2a76207d7b54bd34282281205923841341d9e1f87002d3101000000001976a914b8d4651937cd7db5bcf5fc98e6d2d8cfa131e85088ac743db20a00000000160014c7d0df09e03173170aed0247243874c6872748ed02483045022100b932cda0aeb029922e126568a48c05d79317747dcd77e61dce44e190e140822002202d13f84338bb272c531c4086277ac11e166c59612f4aefa6e20f78455bdc09970121028e6808a8ac1e9ede621aaabfcad6f86662dbe0ace0236f078eb23c24bc88bd5e02483045022100d74a253262e3898626c12361ba9bb5866f9303b42eec0a55ced0578829e2e61e022059c08e61d90cd63c84de61c796c9d1bc1e2f8217892a7c07b383af357ddd7a730121028641e89822127336fc12ff99b1089eb1a124847639a0e98d17ff03a135ad578b000020c71200'

        keypairs = {
          '028e6808a8ac1e9ede621aaabfcad6f86662dbe0ace0236f078eb23c24bc88bd5e':
              (b')\xfd\\T\xf6\xde\xfb\x82.g\xac\xf1S\xe9a\xbaI\xbc\x18=\xfb\xc8Qm\x93a\xbf\x84V\xfc\xbaz', True),
          '028641e89822127336fc12ff99b1089eb1a124847639a0e98d17ff03a135ad578b':
              (b'\x1b\xc6\xd8Q}Y\x08\xae\x06\xe2\xd3Cc8*@nO\xcf\xc7\x12N\xbb\x9a\xe7\xdbA=\x11f\x8cN', True),
          '0375b63dd8e93634bbf162d88b25d6110b5f5a9638f6fe080c85f8b21c2199a1fd':
              (b"\x0e\xb5~\x95gZ\xdd\x97\xfe\xaf8o\xba\x92B\xf8\xdf\xc9\xd7'$\x11\x14|\x83\x19\x9eJ\xda\x9b\xda\xc1", True),
          '04de408e142c00615294813233cdfe9e7774615ae25d18ba4a1e3b70420bb6666d711464518457f8b947034076038c6f0cfc8940d85d3de0386e0ad88614885c7c':
              (b"\xc2\xdec\x00\xd0/\xcd\x0bkN&u\xd0\xf9]I\xb5c}\xe0\x9e\x8c\xb5\x00\x1a\xbft\xbe\x19\xc8'\xb2", False)
        }
        txid = '6ae728f783b0d4680ed8050c05419f0a89dfd6e28d46acfce7453b4d1b2b0254'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed_deserialized),
            (tx_unsigned_raw, tx_signed_raw),
            (keypairs,),
            txid
        )

    def test_tx_p2sh_standard_multisig_2of3(self):
        # deterministic standard multisig wallet
        # 2 in, 2 out, all standard p2sh-multisig with compressed pubkeys

        tx_unsigned_deserialized = {'outputs':[{'scriptPubKey':'a9143f1cb026553db1cdb7214bf21bbdb1cd0136f28b87','address':'2MxzvvenmbpapepAKNJiSchxXMEZ4nXRJ74','value':69997800,'prevout_n':0,'type':0},{'scriptPubKey':'a914648f1c5084c4116ef18aabc3d62fec3100b5944c87','address':'2N2Qvzxz4YVFxLXCEajGdqmGDNoR3EWTbou','value':150000000,'prevout_n':1,'type':0}],'version':1,'inputs':[{'prevout_hash':'5890bcdd3b29e9549a55f05caf80145a433bcb074cf6da83c7ec068f7ef011c8','x_pubkeys':['ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f0500000100','ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a500000100','ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b600000100'],'redeemScript':'52210217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa42102ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb2102f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca53ae','num_sig':2,'signatures':[None,None,None],'scriptSig':'0001ff01ff01ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000001004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000001004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000010053ae','sequence':4294967294,'pubkeys':['0217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa4','02ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb','02f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca'],'prevout_n':0,'address':'2MyEKjJvoYSt94NBy4i2VXUTk1813gJ26um','type':'p2sh'},{'prevout_hash':'fe8719f491985e6d3aaec1124fdcdb21a3132eaa3e57f509e10cf7a94b730d78','x_pubkeys':['ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f0500000000','ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a500000000','ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b600000000'],'redeemScript':'522102159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab12102fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248210363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c99153ae','num_sig':2,'signatures':[None,None,None],'scriptSig':'0001ff01ff01ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000000004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000000004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000000053ae','sequence':4294967294,'pubkeys':['02159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab1','02fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248','0363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c991'],'prevout_n':0,'address':'2MzLtN1fKeESVWfJJESRZembWpb7L27WpwZ','type':'p2sh'}],'lockTime':1230140}
        tx_unsigned_raw = '0100000002c811f07e8f06ecc783daf64c07cb3b435a1480af5cf0559a54e9293bddbc905800000000fd0c010001ff01ff01ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000001004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000001004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000010053aefeffffff780d734ba9f70ce109f5573eaa2e13a321dbdc4f12c1ae3a6d5e9891f41987fe00000000fd0c010001ff01ff01ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000000004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000000004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000000053aefeffffff02e8142c040000000017a9143f1cb026553db1cdb7214bf21bbdb1cd0136f28b8780d1f0080000000017a914648f1c5084c4116ef18aabc3d62fec3100b5944c873cc51200'

        tx_signed1_deserialized = {'outputs':[{'scriptPubKey':'a9143f1cb026553db1cdb7214bf21bbdb1cd0136f28b87','address':'2MxzvvenmbpapepAKNJiSchxXMEZ4nXRJ74','value':69997800,'prevout_n':0,'type':0},{'scriptPubKey':'a914648f1c5084c4116ef18aabc3d62fec3100b5944c87','address':'2N2Qvzxz4YVFxLXCEajGdqmGDNoR3EWTbou','value':150000000,'prevout_n':1,'type':0}],'version':1,'inputs':[{'prevout_hash':'5890bcdd3b29e9549a55f05caf80145a433bcb074cf6da83c7ec068f7ef011c8','x_pubkeys':['ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f0500000100','ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a500000100','ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b600000100'],'redeemScript':'52210217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa42102ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb2102f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca53ae','num_sig':2,'signatures':[None,'304402203fb0f4a22b838b9f072fbab551be3c31c5dce5612f1fbdc66837ff12ac3eeae302200b85fa5c69a051768e15bb9ef295e56f42b843b3e9135e3e10b860aa93eec96401',None],'scriptSig':'0001ff47304402203fb0f4a22b838b9f072fbab551be3c31c5dce5612f1fbdc66837ff12ac3eeae302200b85fa5c69a051768e15bb9ef295e56f42b843b3e9135e3e10b860aa93eec9640101ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000001004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000001004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000010053ae','sequence':4294967294,'pubkeys':['0217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa4','02ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb','02f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca'],'prevout_n':0,'address':'2MyEKjJvoYSt94NBy4i2VXUTk1813gJ26um','type':'p2sh'},{'prevout_hash':'fe8719f491985e6d3aaec1124fdcdb21a3132eaa3e57f509e10cf7a94b730d78','x_pubkeys':['ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f0500000000','ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a500000000','ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b600000000'],'redeemScript':'522102159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab12102fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248210363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c99153ae','num_sig':2,'signatures':[None,'3045022100b23643ce9e116699b36748d888573a132efda5011572c4545ef604026cce062002203c90745efbc09b5a1828b659b7c5172c46a9f9633091f553e7e82d8cddeda39301',None],'scriptSig':'0001ff483045022100b23643ce9e116699b36748d888573a132efda5011572c4545ef604026cce062002203c90745efbc09b5a1828b659b7c5172c46a9f9633091f553e7e82d8cddeda3930101ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000000004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000000004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000000053ae','sequence':4294967294,'pubkeys':['02159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab1','02fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248','0363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c991'],'prevout_n':0,'address':'2MzLtN1fKeESVWfJJESRZembWpb7L27WpwZ','type':'p2sh'}],'lockTime':1230140}
        tx_signed1_raw = '0100000002c811f07e8f06ecc783daf64c07cb3b435a1480af5cf0559a54e9293bddbc905800000000fd52010001ff47304402203fb0f4a22b838b9f072fbab551be3c31c5dce5612f1fbdc66837ff12ac3eeae302200b85fa5c69a051768e15bb9ef295e56f42b843b3e9135e3e10b860aa93eec9640101ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000001004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000001004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000010053aefeffffff780d734ba9f70ce109f5573eaa2e13a321dbdc4f12c1ae3a6d5e9891f41987fe00000000fd53010001ff483045022100b23643ce9e116699b36748d888573a132efda5011572c4545ef604026cce062002203c90745efbc09b5a1828b659b7c5172c46a9f9633091f553e7e82d8cddeda3930101ff4d0201524c53ff0488b21e000000000000000000d6d6585eacca02d7de2b654fb453ab6f88375a5caf46d14d01b9a1bb9f45b76f02d02f7a89e88515a524ba7ce4b7e858bd116a9e2285491bafeaf85be7f0430f05000000004c53ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a5000000004c53ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b60000000053aefeffffff02e8142c040000000017a9143f1cb026553db1cdb7214bf21bbdb1cd0136f28b8780d1f0080000000017a914648f1c5084c4116ef18aabc3d62fec3100b5944c873cc51200'

        tx_signed2_deserialized = {'outputs':[{'scriptPubKey':'a9143f1cb026553db1cdb7214bf21bbdb1cd0136f28b87','address':'2MxzvvenmbpapepAKNJiSchxXMEZ4nXRJ74','value':69997800,'prevout_n':0,'type':0},{'scriptPubKey':'a914648f1c5084c4116ef18aabc3d62fec3100b5944c87','address':'2N2Qvzxz4YVFxLXCEajGdqmGDNoR3EWTbou','value':150000000,'prevout_n':1,'type':0}],'version':1,'inputs':[{'prevout_hash':'5890bcdd3b29e9549a55f05caf80145a433bcb074cf6da83c7ec068f7ef011c8','x_pubkeys':['0217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa4','02ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb','02f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca'],'redeemScript':'52210217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa42102ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb2102f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca53ae','num_sig':2,'signatures':['304402203fb0f4a22b838b9f072fbab551be3c31c5dce5612f1fbdc66837ff12ac3eeae302200b85fa5c69a051768e15bb9ef295e56f42b843b3e9135e3e10b860aa93eec96401','304402207360a1274968e9b28c1fab3f016bd3e671c78ca8327ebc78a13b4373967c1d1902203eab7b05c0b9016073ad642daaf2346317758fc4bc1b2735f5f0aca1a54320c401'],'scriptSig':'0047304402203fb0f4a22b838b9f072fbab551be3c31c5dce5612f1fbdc66837ff12ac3eeae302200b85fa5c69a051768e15bb9ef295e56f42b843b3e9135e3e10b860aa93eec9640147304402207360a1274968e9b28c1fab3f016bd3e671c78ca8327ebc78a13b4373967c1d1902203eab7b05c0b9016073ad642daaf2346317758fc4bc1b2735f5f0aca1a54320c4014c6952210217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa42102ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb2102f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca53ae','sequence':4294967294,'pubkeys':['0217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa4','02ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb','02f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca'],'prevout_n':0,'address':'2MyEKjJvoYSt94NBy4i2VXUTk1813gJ26um','type':'p2sh'},{'prevout_hash':'fe8719f491985e6d3aaec1124fdcdb21a3132eaa3e57f509e10cf7a94b730d78','x_pubkeys':['02159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab1','02fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248','0363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c991'],'redeemScript':'522102159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab12102fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248210363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c99153ae','num_sig':2,'signatures':['3045022100b23643ce9e116699b36748d888573a132efda5011572c4545ef604026cce062002203c90745efbc09b5a1828b659b7c5172c46a9f9633091f553e7e82d8cddeda39301','304402204acfc4bce0771ade0d4c6795e1311144b45e07e633b893a670393fc47b74228002204d024175bc1b551c658e331d29cc9c66ce1b0124f0800b3a09e93428e0c675bf01'],'scriptSig':'00483045022100b23643ce9e116699b36748d888573a132efda5011572c4545ef604026cce062002203c90745efbc09b5a1828b659b7c5172c46a9f9633091f553e7e82d8cddeda3930147304402204acfc4bce0771ade0d4c6795e1311144b45e07e633b893a670393fc47b74228002204d024175bc1b551c658e331d29cc9c66ce1b0124f0800b3a09e93428e0c675bf014c69522102159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab12102fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248210363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c99153ae','sequence':4294967294,'pubkeys':['02159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab1','02fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248','0363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c991'],'prevout_n':0,'address':'2MzLtN1fKeESVWfJJESRZembWpb7L27WpwZ','type':'p2sh'}],'lockTime':1230140}
        tx_signed2_raw = '0100000002c811f07e8f06ecc783daf64c07cb3b435a1480af5cf0559a54e9293bddbc905800000000fc0047304402203fb0f4a22b838b9f072fbab551be3c31c5dce5612f1fbdc66837ff12ac3eeae302200b85fa5c69a051768e15bb9ef295e56f42b843b3e9135e3e10b860aa93eec9640147304402207360a1274968e9b28c1fab3f016bd3e671c78ca8327ebc78a13b4373967c1d1902203eab7b05c0b9016073ad642daaf2346317758fc4bc1b2735f5f0aca1a54320c4014c6952210217cbcf58a02f27112f36ff48805ee234b7a9181d369ab3b1c0d4005929d1caa42102ed1cee0b64838aa73b45ba8e72655f8184a0192123e3559849d67fc173a196eb2102f4f8e1936c600a6b5f06f6a7ffeebcc32a1d25d2133d0b17ffb2edfc8555a5ca53aefeffffff780d734ba9f70ce109f5573eaa2e13a321dbdc4f12c1ae3a6d5e9891f41987fe00000000fdfd0000483045022100b23643ce9e116699b36748d888573a132efda5011572c4545ef604026cce062002203c90745efbc09b5a1828b659b7c5172c46a9f9633091f553e7e82d8cddeda3930147304402204acfc4bce0771ade0d4c6795e1311144b45e07e633b893a670393fc47b74228002204d024175bc1b551c658e331d29cc9c66ce1b0124f0800b3a09e93428e0c675bf014c69522102159594467ddb7273e55fac97a2ea7b59d7ba6b8748ca2a252df09c11431deab12102fcaa73236e45cae839c96401b6b51037e6a7acde763165e7343553f7f16f9248210363d427a878173ab132b60f34775b3798809e31ce21da83c21e0b74af8a68c99153aefeffffff02e8142c040000000017a9143f1cb026553db1cdb7214bf21bbdb1cd0136f28b8780d1f0080000000017a914648f1c5084c4116ef18aabc3d62fec3100b5944c873cc51200'

        keypairs1 = {
          'ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a500000000':
              (b'~Z(\x13\xcf\xc1W\x85\xf6\x8e\x14\x97#\xaab\x01\xafmez\xaf\xc82\xd0\xa0\xfe\xc4\xa6\xdfFw\xb6', True),
          'ff0488b21e000000000000000000057319a0dc77fa4bf47d51e99939ad69469e6637fd5a8db7b82f467b4038b5e7033fe9959a63a41a3791e238c40b92cf4a5a44e8fa6749fe89d2944102d138e5a500000100':
              (b'\x8bP-6 1\x87-%\t\xba\nP\xce\x0fqzm\xbf\x17G\xc8}\xe4\x91;\xa1W\xe10\xbd=', True)
        }
        keypairs2 = {
          'ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b600000100':
              (b'x\xc023\xd4v\x8d\x9b\x92;\xd0\x17\xfd\x04\xe8\t0\xb7\x15\xb2\x93\x04/\x8f\xdf\x9e\x99\xcf\xc7\x10\xe7\x1b', True),
          'ff0488b21e000000000000000000c6992c4d53cff09f298766542714e0d7de30d256429821633a64d8354a253ebe0233d8aec5df4edd3a4ae5804bc7d3bebc02b235d0a49a79e6cd3dd58c0a1e49b600000000':
              (b';\x89v\xac|\xd3\xd41\xe5\x1f\xdb\x089o@\xe5B]y\x83\xbb\xaf-\xd0U<\xc1\xb1\xfc\xabg\xc4', True)
        }
        txid = 'f98198d0ba0773a55c21d471a1e9742cb84609b8783f70a8ca8edf609e09c94c'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed1_deserialized, tx_signed2_deserialized),
            (tx_unsigned_raw, tx_signed1_raw, tx_signed2_raw),
            (keypairs1, keypairs2),
            txid
        )

    def test_tx_p2wsh_p2sh_segwit_multisig_2of3(self):
        # deterministic p2sh-segwit multisig wallet
        # 2 in, 2 out, all p2sh-segwit multisig with compressed pubkeys

        tx_unsigned_deserialized = {'version':1,'lockTime':1230622,'inputs':[{'num_sig':2,'scriptSig':'220020df82e82b888be3aa7433ef0dfe30fbaa8f6159d710e1def86a5b743a128515f0','signatures':[None,None,None],'sequence':4294967293,'witnessScript':'522102203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad21033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a21039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e6653ae','value':110000000,'prevout_n':0,'type':'p2wsh-p2sh','pubkeys':['02203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad','033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a','039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e66'],'x_pubkeys':['ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a8300000100','ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a00000100','ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf00000100'],'address':'2N2r4naPwZMupGwdXUwHeCzGTKD9GiDtTad','prevout_hash':'ab873bb5299a251acd76df2a31c723f603efcaba1c45eda6495000e46ce96539'},{'num_sig':2,'scriptSig':'2200200092b78843494c976e0616977c41986db60dd01e7183bb0cdc9879beb9af3cbb','signatures':[None,None,None],'sequence':4294967293,'witnessScript':'522103b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b142103caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f2103cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f53ae','value':50000000,'prevout_n':0,'type':'p2wsh-p2sh','pubkeys':['03b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b14','03caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f','03cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f'],'x_pubkeys':['ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a8300000000','ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf00000000','ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a00000000'],'address':'2MyHkXnw4PfJxqNj6t6mtGctvPGGxdSZQ9e','prevout_hash':'bb7cc2fdae3f8219e1ad20c6bc1415eddcaafc416aeb2e006ad422ab1229e946'}],'outputs':[{'prevout_n':0,'type':0,'scriptPubKey':'a914d2a3faf19cbb6841c363491a0154bb63bd53cb1687','address':'2NCSzL7foDAfyBCsCCrvWrq9mR7WZmB5Zo8','value':39999500},{'prevout_n':1,'type':0,'scriptPubKey':'a914d2f77ae0b7457e1328ba35bfb1a44fa588e675c387','address':'2NCUiMnAowQPEXhfLXBVJjgpKvZtQc2EEQy','value':120000000}]}
        tx_unsigned_raw = '010000000001023965e96ce4005049a6ed451cbacaef03f623c7312adf76cd1a259a29b53b87ab0000000023220020df82e82b888be3aa7433ef0dfe30fbaa8f6159d710e1def86a5b743a128515f0fdffffff46e92912ab22d46a002eeb6a41fcaadced1514bcc620ade119823faefdc27cbb00000000232200200092b78843494c976e0616977c41986db60dd01e7183bb0cdc9879beb9af3cbbfdffffff020c5862020000000017a914d2a3faf19cbb6841c363491a0154bb63bd53cb1687000e27070000000017a914d2f77ae0b7457e1328ba35bfb1a44fa588e675c387feffffffff80778e0600000000050001ff01ff01fffd0201524c53ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a83000001004c53ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a000001004c53ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf0000010053aefeffffffff80f0fa0200000000050001ff01ff01fffd0201524c53ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a83000000004c53ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf000000004c53ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a0000000053ae1ec71200'

        tx_signed1_deserialized = {'lockTime':1230622,'outputs':[{'value':39999500,'type':0,'address':'2NCSzL7foDAfyBCsCCrvWrq9mR7WZmB5Zo8','prevout_n':0,'scriptPubKey':'a914d2a3faf19cbb6841c363491a0154bb63bd53cb1687'},{'value':120000000,'type':0,'address':'2NCUiMnAowQPEXhfLXBVJjgpKvZtQc2EEQy','prevout_n':1,'scriptPubKey':'a914d2f77ae0b7457e1328ba35bfb1a44fa588e675c387'}],'version':1,'inputs':[{'sequence':4294967293,'address':'2N2r4naPwZMupGwdXUwHeCzGTKD9GiDtTad','value':110000000,'x_pubkeys':['ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a8300000100','ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a00000100','ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf00000100'],'prevout_n':0,'scriptSig':'220020df82e82b888be3aa7433ef0dfe30fbaa8f6159d710e1def86a5b743a128515f0','pubkeys':['02203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad','033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a','039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e66'],'num_sig':2,'witnessScript':'522102203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad21033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a21039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e6653ae','prevout_hash':'ab873bb5299a251acd76df2a31c723f603efcaba1c45eda6495000e46ce96539','type':'p2wsh-p2sh','signatures':['3044022053e8ef255d5a499ed72154f9331b84e479c2eeae600ba90141e95eaa60a8c273022013c90f1a60e4d80e014dbae88b835d62241dd138982093a011a893ef231327db01',None,None]},{'sequence':4294967293,'address':'2MyHkXnw4PfJxqNj6t6mtGctvPGGxdSZQ9e','value':50000000,'x_pubkeys':['ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a8300000000','ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf00000000','ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a00000000'],'prevout_n':0,'scriptSig':'2200200092b78843494c976e0616977c41986db60dd01e7183bb0cdc9879beb9af3cbb','pubkeys':['03b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b14','03caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f','03cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f'],'num_sig':2,'witnessScript':'522103b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b142103caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f2103cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f53ae','prevout_hash':'bb7cc2fdae3f8219e1ad20c6bc1415eddcaafc416aeb2e006ad422ab1229e946','type':'p2wsh-p2sh','signatures':['3045022100f878c8d04af885c7a381083ab1acf87ea5e382a052d61d8b76599378c0a3638e0220222b48096a8fb6764903e1235b3d221d9d6912d73adc1b40749a142ea5e7516e01',None,None]}]}
        tx_signed1_raw = '010000000001023965e96ce4005049a6ed451cbacaef03f623c7312adf76cd1a259a29b53b87ab0000000023220020df82e82b888be3aa7433ef0dfe30fbaa8f6159d710e1def86a5b743a128515f0fdffffff46e92912ab22d46a002eeb6a41fcaadced1514bcc620ade119823faefdc27cbb00000000232200200092b78843494c976e0616977c41986db60dd01e7183bb0cdc9879beb9af3cbbfdffffff020c5862020000000017a914d2a3faf19cbb6841c363491a0154bb63bd53cb1687000e27070000000017a914d2f77ae0b7457e1328ba35bfb1a44fa588e675c387feffffffff80778e06000000000500473044022053e8ef255d5a499ed72154f9331b84e479c2eeae600ba90141e95eaa60a8c273022013c90f1a60e4d80e014dbae88b835d62241dd138982093a011a893ef231327db0101ff01fffd0201524c53ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a83000001004c53ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a000001004c53ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf0000010053aefeffffffff80f0fa02000000000500483045022100f878c8d04af885c7a381083ab1acf87ea5e382a052d61d8b76599378c0a3638e0220222b48096a8fb6764903e1235b3d221d9d6912d73adc1b40749a142ea5e7516e0101ff01fffd0201524c53ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a83000000004c53ff0295b43f030e6f0f2a80000000e66428321e976f71604ca6b711c771c0e9ff88897ad35c54c1c47516bc1acf3d0306108ed01bc86b4d11399f495ddeb6c4111de47866df17af26d997bda05c9cbf000000004c53ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a0000000053ae1ec71200'

        tx_signed2_deserialized = {'lockTime':1230622,'outputs':[{'value':39999500,'type':0,'address':'2NCSzL7foDAfyBCsCCrvWrq9mR7WZmB5Zo8','prevout_n':0,'scriptPubKey':'a914d2a3faf19cbb6841c363491a0154bb63bd53cb1687'},{'value':120000000,'type':0,'address':'2NCUiMnAowQPEXhfLXBVJjgpKvZtQc2EEQy','prevout_n':1,'scriptPubKey':'a914d2f77ae0b7457e1328ba35bfb1a44fa588e675c387'}],'version':1,'inputs':[{'pubkeys':['02203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad','033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a','039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e66'],'sequence':4294967293,'witnessScript':'522102203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad21033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a21039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e6653ae','x_pubkeys':['02203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad','033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a','039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e66'],'type':'p2wsh-p2sh','prevout_hash':'ab873bb5299a251acd76df2a31c723f603efcaba1c45eda6495000e46ce96539','num_sig':2,'address':'2N2r4naPwZMupGwdXUwHeCzGTKD9GiDtTad','prevout_n':0,'signatures':['3044022053e8ef255d5a499ed72154f9331b84e479c2eeae600ba90141e95eaa60a8c273022013c90f1a60e4d80e014dbae88b835d62241dd138982093a011a893ef231327db01','3045022100e4173aa3eceb2457ca568ed5107f302c96b3af29737e7e5856ba6daf253d1e9b022015d3e4e144c8c140beedf36f2a09d2ede0a1c0320e49ce0ed525996c009378e401'],'scriptSig':'220020df82e82b888be3aa7433ef0dfe30fbaa8f6159d710e1def86a5b743a128515f0'},{'pubkeys':['03b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b14','03caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f','03cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f'],'sequence':4294967293,'witnessScript':'522103b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b142103caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f2103cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f53ae','x_pubkeys':['03b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b14','03caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f','03cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f'],'type':'p2wsh-p2sh','prevout_hash':'bb7cc2fdae3f8219e1ad20c6bc1415eddcaafc416aeb2e006ad422ab1229e946','num_sig':2,'address':'2MyHkXnw4PfJxqNj6t6mtGctvPGGxdSZQ9e','prevout_n':0,'signatures':['3045022100f878c8d04af885c7a381083ab1acf87ea5e382a052d61d8b76599378c0a3638e0220222b48096a8fb6764903e1235b3d221d9d6912d73adc1b40749a142ea5e7516e01','3045022100f256f93b9e92f90a937811192f4c4d817029629141d4b9e9c23bff2e3f07a48702207fe17e9982d89d2439dd5f3c418ac23707dbc99de11c584a9d479a07687105f201'],'scriptSig':'2200200092b78843494c976e0616977c41986db60dd01e7183bb0cdc9879beb9af3cbb'}]}
        tx_signed2_raw = '010000000001023965e96ce4005049a6ed451cbacaef03f623c7312adf76cd1a259a29b53b87ab0000000023220020df82e82b888be3aa7433ef0dfe30fbaa8f6159d710e1def86a5b743a128515f0fdffffff46e92912ab22d46a002eeb6a41fcaadced1514bcc620ade119823faefdc27cbb00000000232200200092b78843494c976e0616977c41986db60dd01e7183bb0cdc9879beb9af3cbbfdffffff020c5862020000000017a914d2a3faf19cbb6841c363491a0154bb63bd53cb1687000e27070000000017a914d2f77ae0b7457e1328ba35bfb1a44fa588e675c3870400473044022053e8ef255d5a499ed72154f9331b84e479c2eeae600ba90141e95eaa60a8c273022013c90f1a60e4d80e014dbae88b835d62241dd138982093a011a893ef231327db01483045022100e4173aa3eceb2457ca568ed5107f302c96b3af29737e7e5856ba6daf253d1e9b022015d3e4e144c8c140beedf36f2a09d2ede0a1c0320e49ce0ed525996c009378e40169522102203152e0812cd78e09d8ae8301d8fc6b06d1d6c74d9fcb7a8c09ca2a610d05ad21033eeaae76e18f4498d59e0f95fd2dbda70936dc1256aea21ca8837480b2c2e61a21039f3fda72af3e65f7167ba17653ebfcbe9a7ebccc6907144aad7dae1b664f5e6653ae0400483045022100f878c8d04af885c7a381083ab1acf87ea5e382a052d61d8b76599378c0a3638e0220222b48096a8fb6764903e1235b3d221d9d6912d73adc1b40749a142ea5e7516e01483045022100f256f93b9e92f90a937811192f4c4d817029629141d4b9e9c23bff2e3f07a48702207fe17e9982d89d2439dd5f3c418ac23707dbc99de11c584a9d479a07687105f20169522103b082997e2ab907f7202188c500abd85f82d7d7a6372e3401f34f4afb048f2b142103caf407b7a59fd7894e6e8ef1ca62696f5c71e45ba58e93f417141d533e92bc1f2103cb6ff72c2311881f4f7e14a1309da5b4666b1151bd0655f77f0cac2087d6044f53ae1ec71200'

        keypairs1 = {
          'ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a8300000100':
              (b'\xbc/\\D\x95E\x93\xf2(\xeeR\xba\xa2N\xac\xdcL=:e\xee\xef\x0b\x87\xf7n\x1d\xd9\x91y\x8e[', True),
          'ff0295b43f03287a6b43800000008f73c2a4c2094244d3406ab259ae21b6cf810f20f76863d7b812b643e3eaaa46028592d2ab81e1a2cf736c9a55d7008fb606865c8a8e4f51c04e69aaab4ea06a8300000000':
              (b'\xcbZ\x19\xd2\x96\xe0\xd2\xde\xfb(\xe5\x1b\xac\x02\x99\xc1\x89k\xc4\xa6\x19\xcdW\x80\xaf\xc7\x05/\xd7\x05\x01$', True)
        }
        keypairs2 = {
          'ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a00000000':
              (b'\xa4\xa4\x16\xab\xbc\x01\xdb\x8c"\x83Y\xbf\xc3\x1a4\xe9\xd0\xd0\x1e\xd3\xfa\x92\x81b\xe9J\xe9=\xc7C\xe0u', True),
          'ff0295b43f03f8804f76800000003069e7491dac5fcbf4094918327cfe753add4dd74175b6480d6f53715e5420f803184c2ab31681f62c19f08f9df9fef5142d5312fc58337faf55b6227070ba478a00000100':
              (b"\xe9\x8f`\xa8k\x8e\x80'\x92\x8a\x0c)\x812\n\xce>\x8f7*\xc7d\x00\xf4\x9e,2\xf0\x00\x9f\x1b\x13", True)
        }
        txid = '3a822283c9c57463be5731f5020c68f6692e3cceaee4e410ee06a4d38d6a1b68'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed1_deserialized, tx_signed2_deserialized),
            (tx_unsigned_raw, tx_signed1_raw, tx_signed2_raw),
            (keypairs1, keypairs2),
            txid
        )

    def test_tx_p2wsh_segwit_multisig_2of3(self):
        # deterministic segwit multisig wallet
        # 2 in, 2 out, all native segwit multisig with compressed pubkeys

        tx_unsigned_deserialized = {'version':1,'lockTime':1230191,'outputs':[{'type':0,'value':32491000,'scriptPubKey':'00202fa892744cdb4b04d155e7627a04bb0b92064787e6dcb6dcd69ee0e885407db6','address':'tb1q975fyazvmd9sf524ua385p9mpwfqv3u8umwtdhxknmsw3p2q0kmq3x2k0n','prevout_n':0},{'type':0,'value':150000000,'scriptPubKey':'00206d73c5adadbe3bcd0f691fbcbd1ff67576d774240fef297de865dae29cbf74cc','address':'tb1qd4euttddhcau6rmfr77t68lkw4mdwapyplhjjl0gvhdw989lwnxq857r20','prevout_n':1}],'inputs':[{'pubkeys':['0285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b','02ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac482334','03f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab64'],'value':122497308,'witnessScript':'52210285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b2102ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac4823342103f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab6453ae','scriptSig':'','prevout_hash':'156d6cccb8cd886743a8978a9e41a95c313cac405e77ba035d4ddacfaa8667f9','signatures':[None,None,None],'prevout_n':0,'address':'tb1qf8ytts0vqq2lrpuh4xwe7lwufnjmytkep20skkku4q7rdmwrsngswcrxqt','num_sig':2,'x_pubkeys':['ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e00000100','ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b23800000100','ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c00000100'],'sequence':4294967294,'type':'p2wsh'},{'pubkeys':['020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79','0277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c6','03dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c'],'value':59994271,'witnessScript':'5221020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79210277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c62103dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c53ae','scriptSig':'','prevout_hash':'72419d187c61cfc67a011095566b374dc2c01f5397e36eafe68e40fc44474112','signatures':[None,None,None],'prevout_n':0,'address':'tb1qyl8fprzwuh6mw668yfm47glzp328fazevxdegpqztq5s89dc3tas57ynaw','num_sig':2,'x_pubkeys':['ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c00000000','ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e00000000','ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b23800000000'],'sequence':4294967294,'type':'p2wsh'}]}
        tx_unsigned_raw = '01000000000102f96786aacfda4d5d03ba775e40ac3c315ca9419e8a97a8436788cdb8cc6c6d150000000000feffffff12414744fc408ee6af6ee397531fc0c24d376b569510017ac6cf617c189d41720000000000feffffff02f8c5ef01000000002200202fa892744cdb4b04d155e7627a04bb0b92064787e6dcb6dcd69ee0e885407db680d1f008000000002200206d73c5adadbe3bcd0f691fbcbd1ff67576d774240fef297de865dae29cbf74ccfeffffffff1c294d0700000000050001ff01ff01fffd0201524c53ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e000001004c53ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b238000001004c53ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c0000010053aefeffffffff9f70930300000000050001ff01ff01fffd0201524c53ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c000000004c53ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e000000004c53ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b2380000000053ae6fc51200'

        tx_signed1_deserialized = {'version':1,'lockTime':1230191,'outputs':[{'type':0,'value':32491000,'scriptPubKey':'00202fa892744cdb4b04d155e7627a04bb0b92064787e6dcb6dcd69ee0e885407db6','address':'tb1q975fyazvmd9sf524ua385p9mpwfqv3u8umwtdhxknmsw3p2q0kmq3x2k0n','prevout_n':0},{'type':0,'value':150000000,'scriptPubKey':'00206d73c5adadbe3bcd0f691fbcbd1ff67576d774240fef297de865dae29cbf74cc','address':'tb1qd4euttddhcau6rmfr77t68lkw4mdwapyplhjjl0gvhdw989lwnxq857r20','prevout_n':1}],'inputs':[{'pubkeys':['0285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b','02ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac482334','03f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab64'],'value':122497308,'witnessScript':'52210285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b2102ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac4823342103f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab6453ae','scriptSig':'','prevout_hash':'156d6cccb8cd886743a8978a9e41a95c313cac405e77ba035d4ddacfaa8667f9','signatures':[None,'30440220446dc08da35f3bfa149d38b1b857b3dfa72636ccf577b00cefa511aca94255af022017770533b8ed318f3e9d5a703d7c445b57b46dab6c5c24cee095cb76896ec18801',None],'prevout_n':0,'address':'tb1qf8ytts0vqq2lrpuh4xwe7lwufnjmytkep20skkku4q7rdmwrsngswcrxqt','num_sig':2,'x_pubkeys':['ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e00000100','ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b23800000100','ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c00000100'],'sequence':4294967294,'type':'p2wsh'},{'pubkeys':['020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79','0277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c6','03dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c'],'value':59994271,'witnessScript':'5221020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79210277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c62103dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c53ae','scriptSig':'','prevout_hash':'72419d187c61cfc67a011095566b374dc2c01f5397e36eafe68e40fc44474112','signatures':[None,None,'3044022001c070509367088ceb2976410da4bf595f3fbf14283695b83739f8bd4be88e8c0220160717cd2e79be26bc4378b9492326a46f2776eae4c7103f5213639a93fe1b8201'],'prevout_n':0,'address':'tb1qyl8fprzwuh6mw668yfm47glzp328fazevxdegpqztq5s89dc3tas57ynaw','num_sig':2,'x_pubkeys':['ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c00000000','ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e00000000','ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b23800000000'],'sequence':4294967294,'type':'p2wsh'}]}
        tx_signed1_raw = '01000000000102f96786aacfda4d5d03ba775e40ac3c315ca9419e8a97a8436788cdb8cc6c6d150000000000feffffff12414744fc408ee6af6ee397531fc0c24d376b569510017ac6cf617c189d41720000000000feffffff02f8c5ef01000000002200202fa892744cdb4b04d155e7627a04bb0b92064787e6dcb6dcd69ee0e885407db680d1f008000000002200206d73c5adadbe3bcd0f691fbcbd1ff67576d774240fef297de865dae29cbf74ccfeffffffff1c294d0700000000050001ff4730440220446dc08da35f3bfa149d38b1b857b3dfa72636ccf577b00cefa511aca94255af022017770533b8ed318f3e9d5a703d7c445b57b46dab6c5c24cee095cb76896ec1880101fffd0201524c53ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e000001004c53ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b238000001004c53ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c0000010053aefeffffffff9f70930300000000050001ff01ff473044022001c070509367088ceb2976410da4bf595f3fbf14283695b83739f8bd4be88e8c0220160717cd2e79be26bc4378b9492326a46f2776eae4c7103f5213639a93fe1b8201fd0201524c53ff02aa7ed30117f23f318000000139099a06ecf0dd3cd3f99fcb8c87f461c4c6f688feb687c5818ee2620f8d7acb032ab2d0cee9696de7d7441c221f62dd1f3819eb5aff3f5e78122425216f825e7c000000004c53ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e000000004c53ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b2380000000053ae6fc51200'

        tx_signed2_deserialized = {'version':1,'lockTime':1230191,'outputs':[{'type':0,'value':32491000,'scriptPubKey':'00202fa892744cdb4b04d155e7627a04bb0b92064787e6dcb6dcd69ee0e885407db6','address':'tb1q975fyazvmd9sf524ua385p9mpwfqv3u8umwtdhxknmsw3p2q0kmq3x2k0n','prevout_n':0},{'type':0,'value':150000000,'scriptPubKey':'00206d73c5adadbe3bcd0f691fbcbd1ff67576d774240fef297de865dae29cbf74cc','address':'tb1qd4euttddhcau6rmfr77t68lkw4mdwapyplhjjl0gvhdw989lwnxq857r20','prevout_n':1}],'inputs':[{'x_pubkeys':['0285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b','02ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac482334','03f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab64'],'sequence':4294967294,'scriptSig':'','witnessScript':'52210285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b2102ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac4823342103f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab6453ae','signatures':['304402202876587c78a6002e8d13a725bb2b07b1af7d64bd519ed6782a09228073a2288402206bb7866e921f4ea16b873a152c3d2997a3f43c5d1d26b4f0c438deb06f3905fe01','30440220446dc08da35f3bfa149d38b1b857b3dfa72636ccf577b00cefa511aca94255af022017770533b8ed318f3e9d5a703d7c445b57b46dab6c5c24cee095cb76896ec18801'],'type':'p2wsh','prevout_hash':'156d6cccb8cd886743a8978a9e41a95c313cac405e77ba035d4ddacfaa8667f9','pubkeys':['0285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b','02ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac482334','03f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab64'],'prevout_n':0,'address':'tb1qf8ytts0vqq2lrpuh4xwe7lwufnjmytkep20skkku4q7rdmwrsngswcrxqt','num_sig':2},{'x_pubkeys':['020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79','0277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c6','03dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c'],'sequence':4294967294,'scriptSig':'','witnessScript':'5221020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79210277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c62103dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c53ae','signatures':['3045022100d0ffc7b5253e4618ebd592403f93df927f20e00936b70d41217be1134916aeba02204710eaef710a92d5d3f9b54b3326fe55130e644abf4c96db98e5c4aef821eec801','3044022001c070509367088ceb2976410da4bf595f3fbf14283695b83739f8bd4be88e8c0220160717cd2e79be26bc4378b9492326a46f2776eae4c7103f5213639a93fe1b8201'],'type':'p2wsh','prevout_hash':'72419d187c61cfc67a011095566b374dc2c01f5397e36eafe68e40fc44474112','pubkeys':['020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79','0277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c6','03dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c'],'prevout_n':0,'address':'tb1qyl8fprzwuh6mw668yfm47glzp328fazevxdegpqztq5s89dc3tas57ynaw','num_sig':2}]}
        tx_signed2_raw = '01000000000102f96786aacfda4d5d03ba775e40ac3c315ca9419e8a97a8436788cdb8cc6c6d150000000000feffffff12414744fc408ee6af6ee397531fc0c24d376b569510017ac6cf617c189d41720000000000feffffff02f8c5ef01000000002200202fa892744cdb4b04d155e7627a04bb0b92064787e6dcb6dcd69ee0e885407db680d1f008000000002200206d73c5adadbe3bcd0f691fbcbd1ff67576d774240fef297de865dae29cbf74cc040047304402202876587c78a6002e8d13a725bb2b07b1af7d64bd519ed6782a09228073a2288402206bb7866e921f4ea16b873a152c3d2997a3f43c5d1d26b4f0c438deb06f3905fe014730440220446dc08da35f3bfa149d38b1b857b3dfa72636ccf577b00cefa511aca94255af022017770533b8ed318f3e9d5a703d7c445b57b46dab6c5c24cee095cb76896ec188016952210285ea9c04049e95301ef03caf6888b9d5bcd0979e31e0ea61cc21082584bdba4b2102ccdd6b08f7ba09a2435a0888625dc94ca8e828453c3ca0261ea810d9ac4823342103f2f502dbbdc4ffbd710e72273286c4c237ffde068615574f4c0cc5b7a08dab6453ae0400483045022100d0ffc7b5253e4618ebd592403f93df927f20e00936b70d41217be1134916aeba02204710eaef710a92d5d3f9b54b3326fe55130e644abf4c96db98e5c4aef821eec801473044022001c070509367088ceb2976410da4bf595f3fbf14283695b83739f8bd4be88e8c0220160717cd2e79be26bc4378b9492326a46f2776eae4c7103f5213639a93fe1b8201695221020a17e67144158c39762c2bd91f0af0a5b9c756f8d61f02506910c58a3f5f0f79210277ef19fc6f7d744eab9f396c5178b23df85056f215ffb6bd6081fdcb5301e1c62103dd30600e5eb4cffe3fb1fca77c1505b43a5d178a41cfaf97c4f2d34994efce5c53ae6fc51200'

        keypairs1 = {
          'ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b23800000000':
              (b'\xa4\x01\x953\x8c\x86P\x1fR\xd5\xcf\xe3\xd6\xb0\xfaT\xe4\xa0\xb0U\xdb\x7f\xab\xe0.\xe5\xb3J\x9dK\x90!', True),
          'ff02aa7ed3012e50196d800000016f262633323d5d64ab518889540175fcd01b6cf7bc3bf3487ee933bebd773a260231750caddb75e53157d143be3811138f82a65837922a7a3768d28ad99e72b23800000100':
              (b'\x133\x83\xeb\x10(\x96\xc4\xb6\xc7\\\x9d\xef\xe0\xc2O\x9be\xf3`@F\x1f\xc7\xc7\x89\x00\x14@\x03%o', True)
        }
        keypairs2 = {
          'ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e00000000':
              (b'>\x0c\xbfZe~-\xa9\xcd\xe9B\xaf\xb1\x13\xe4\xa8\x14\xb8N\xec\xff\\\xed\xd0\xc3\xf7M\xc6\xca\xbeu<', True),
          'ff02aa7ed30140f8c3c780000001da2ac88c39dbf2e05f2282ddb486fe750a1a639272f92469302778c77376a33002be4a6f6cae63a0c02810a87cc969c0e29cce8e20ef07e2f7ea8627969450bd0e00000100':
              (b'\xd0\xad\rAv\xb5\x1bN\x01+|1wH}\x9d\xa6\xf96\xd2\x80\x12\x16>|\xc5Ib\nd\x1c\xd0', True)
        }
        txid = '6690a6521763076340979b28001058fc93eafe8035d347c4bb956551c9494387'

        self._test_transaction(
            (tx_unsigned_deserialized, tx_signed1_deserialized, tx_signed2_deserialized),
            (tx_unsigned_raw, tx_signed1_raw, tx_signed2_raw),
            (keypairs1, keypairs2),
            txid
        )

    def _test_transaction(self, txs_deserialized, txs_raw, keypairss, txid):
        '''Reconstructs and signs raw transactions, and does some naive checks.
        Handles both single signer and multisig transactions.

        Below, m is the number of required cosigners

        :param txs_deserialized: iterable containing deserialised txs, one for
                each state after another cosigner signed:
                1 unsigned + m-1 partial + 1 fully signed = m+1
        :param txs_raw: iterable containing raw txs, one for each state (m+1)
        :param keypairss: iterable containing keypairs for each of the
                m cosigners
        '''

        self.assertEqual(len(txs_deserialized), len(txs_raw))
        for tx_deserialized, tx_raw in zip(txs_deserialized, txs_raw):
            self.assertEqual(tx_deserialized, deserialize(tx_raw))

        # reconstruct unsigned tx
        tx = Transaction(txs_raw[0])
        self.assertEqual(txs_raw[0], str(tx))
        self.assertFalse(tx.is_complete())

        # add signatures
        # each iteration is one cosigner signing
        for i, tx_raw, keypairs in zip(range(1, len(txs_raw)+1), txs_raw[1:], keypairss):
            tx_prev = copy.deepcopy(tx)

            # sign tx
            tx.sign(keypairs)
            self.assertEqual(tx_raw, str(tx))

            # after last signature added, tx should be complete
            self.assertEqual(i + 1 == len(txs_raw), tx.is_complete())
            if tx.is_complete() or tx.is_segwit():
                self.assertEqual(txid, tx.txid())

            # sanity checks of some transitive properties
            self.assertEqual(tx.is_segwit(),    tx_prev.is_segwit())
            self.assertEqual(tx.is_final(),     tx_prev.is_final())
            self.assertEqual(tx.output_value(), tx_prev.output_value())

    @classmethod
    def setUpClass(cls):
        super().setUpClass()
        bitcoin.NetworkConstants.set_testnet()

    @classmethod
    def tearDownClass(cls):
        super().tearDownClass()
        bitcoin.NetworkConstants.set_mainnet()
